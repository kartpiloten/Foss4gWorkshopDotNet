# Rover Scent Detection System - Architecture Overview

## System Architecture Diagram

```
???????????????????????????????????????????????????????????????????????????????
?                           PRESENTATION LAYER                                 ?
???????????????????????????????????????????????????????????????????????????????
?                                                                               ?
?  ?????????????????????????????????????????????????????????????????????????  ?
?  ?              Blazor Server Application (FrontendVersion2)             ?  ?
?  ?                                                                       ?  ?
?  ?  ????????????????   ????????????????   ????????????????            ?  ?
?  ?  ? Index.razor  ?   ?  Program.cs  ?   ? Leaflet.js   ?            ?  ?
?  ?  ?  (UI Page)   ????? (API Routes) ????? (Map Layer)  ?            ?  ?
?  ?  ????????????????   ????????????????   ????????????????            ?  ?
?  ?                                                                       ?  ?
?  ?  • Real-time map visualization                                       ?  ?
?  ?  • GeoJSON API endpoints                                             ?  ?
?  ?  • JavaScript Interop for mapping                                    ?  ?
?  ?????????????????????????????????????????????????????????????????????????  ?
?                                    ?                                          ?
?                                    ? GeoJSON / WKT                            ?
?????????????????????????????????????????????????????????????????????????????????
                                     ?
?????????????????????????????????????????????????????????????????????????????????
?                           SERVICE LAYER                                       ?
?????????????????????????????????????????????????????????????????????????????????
?                                    ?                                          ?
?  ?????????????????????????????????????????????????????????????????????????  ?
?  ?           ScentPolygonService (IHostedService)                        ?  ?
?  ?                                                                       ?  ?
?  ?  ????????????????????????????????????????????????????????????????   ?  ?
?  ?  ?  Timer (Polls every 1 second)                                ?   ?  ?
?  ?  ????????????????????????????????????????????????????????????????   ?  ?
?  ?                                                                       ?  ?
?  ?  ????????????????????????????????????????????????????????????????   ?  ?
?  ?  ?  ConcurrentDictionary<int, ScentPolygonResult>               ?   ?  ?
?  ?  ?  • Thread-safe polygon storage                                ?   ?  ?
?  ?  ?  • In-memory collection                                       ?   ?  ?
?  ?  ????????????????????????????????????????????????????????????????   ?  ?
?  ?                                                                       ?  ?
?  ?  ????????????????????????????????????????????????????????????????   ?  ?
?  ?  ?  Events:                                                      ?   ?  ?
?  ?  ?  • PolygonsUpdated (new scent polygons)                      ?   ?  ?
?  ?  ?  • StatusUpdate (periodic status)                            ?   ?  ?
?  ?  ????????????????????????????????????????????????????????????????   ?  ?
?  ?                                                                       ?  ?
?  ?  Key Methods:                                                         ?  ?
?  ?  • GetAllPolygons()                                                   ?  ?
?  ?  • GetLatestPolygons(count)                                           ?  ?
?  ?  • GetUnifiedScentPolygon()          ??? NEW: Unified Coverage       ?  ?
?  ?  • GetUnifiedScentPolygonCached()    ??? Cached version              ?  ?
?  ?????????????????????????????????????????????????????????????????????????  ?
?                                    ?                                          ?
?                                    ?                                          ?
?                                    ?                                          ?
?  ?????????????????????????????????????????????????????????????????????????  ?
?  ?              ScentPolygonCalculator (Static Utilities)                ?  ?
?  ?                                                                       ?  ?
?  ?  • CreateScentPolygon() - Generate individual polygon                ?  ?
?  ?  • CreateUnifiedPolygon() - Combine multiple polygons                ?  ?
?  ?  • CalculateScentAreaM2() - Calculate area                           ?  ?
?  ?  • CalculateMaxScentDistance() - Wind speed modeling                 ?  ?
?  ?  • PolygonToText() / UnifiedPolygonToText() - Text output            ?  ?
?  ?                                                                       ?  ?
?  ?  Uses: NetTopologySuite for spatial operations                       ?  ?
?  ?????????????????????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????????????????????
                                     ?
?????????????????????????????????????????????????????????????????????????????????
?                           DATA ACCESS LAYER                                   ?
?????????????????????????????????????????????????????????????????????????????????
?                                    ?                                          ?
?  ?????????????????????????????????????????????????????????????????????????  ?
?  ?              IRoverDataReader (Interface)                             ?  ?
?  ?????????????????????????????????????????????????????????????????????????  ?
?                   ?                                 ?                         ?
?         ?????????????????????         ?????????????????????????             ?
?         ?                   ?         ?                        ?             ?
?  ???????????????????  ???????????????????????  ????????????????????????    ?
?  ? PostgresRover   ?  ? GeoPackageRover     ?  ? RoverDataReader      ?    ?
?  ? DataReader      ?  ? DataReader          ?  ? Factory              ?    ?
?  ???????????????????  ???????????????????????  ????????????????????????    ?
?         ?                      ?                         ?                   ?
?         ?                      ?                         ?                   ?
?  • GetAllMeasurementsAsync()                                                 ?
?  • GetNewMeasurementsAsync(lastSequence)                                     ?
?  • GetLatestMeasurementAsync()                                               ?
?  • InitializeAsync()                                                         ?
???????????????????????????????????????????????????????????????????????????????
                                     ?
?????????????????????????????????????????????????????????????????????????????????
?                           DATA STORAGE LAYER                                  ?
?????????????????????????????????????????????????????????????????????????????????
?                                    ?                                          ?
?  ???????????????????????????????????    ????????????????????????????????    ?
?  ?   PostgreSQL Database            ?    ?   GeoPackage Files           ?    ?
?  ?   192.168.1.254:5432            ?    ?   C:\temp\Rover1\            ?    ?
?  ?                                  ?    ?                              ?    ?
?  ?   AucklandRoverData Database    ?    ?   • rover_measurements.gpkg  ?    ?
?  ?   • rover_measurements table    ?    ?   • Spatialite/GPKG format   ?    ?
?  ?   • PostGIS spatial types       ?    ?                              ?    ?
?  ???????????????????????????????????    ????????????????????????????????    ?
?                  ?                                    ?                       ?
?????????????????????????????????????????????????????????????????????????????????
                   ?                                    ?
?????????????????????????????????????????????????????????????????????????????????
?                           DATA GENERATION LAYER                               ?
?????????????????????????????????????????????????????????????????????????????????
?                  ?                                    ?                       ?
?  ???????????????????????????????????????????????????????????????????????    ?
?  ?                     RoverSimulator                                   ?    ?
?  ?                                                                      ?    ?
?  ?  • Simulates rover GPS movements                                    ?    ?
?  ?  • Generates wind measurements (speed + direction)                  ?    ?
?  ?  • Writes to PostgreSQL or GeoPackage                               ?    ?
?  ?  • Creates session-based measurement sequences                      ?    ?
?  ????????????????????????????????????????????????????????????????????????    ?
???????????????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????????????
?                           TESTING/MONITORING LAYER                            ?
???????????????????????????????????????????????????????????????????????????????
?                                                                               ?
?  ?????????????????????????????????????????????????????????????????????????  ?
?  ?              ScentPolygonTester (Console Application)                 ?  ?
?  ?                                                                       ?  ?
?  ?  • Monitors ScentPolygonService in real-time                         ?  ?
?  ?  • Outputs to GeoPackage for QGIS visualization                      ?  ?
?  ?  • Displays live polygon generation statistics                       ?  ?
?  ?  • Tests unified polygon functionality                               ?  ?
?  ?                                                                       ?  ?
?  ?  Output: C:\temp\Rover1\ScentPolygons.gpkg                           ?  ?
?  ?????????????????????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????????????????????
```

---

## Key Components Description

### 1. **Presentation Layer** (FrontendVersion2)
- **Technology**: Blazor Server (.NET 9)
- **Purpose**: Real-time web-based map visualization
- **Key Features**:
  - Interactive Leaflet.js map
  - GeoJSON API endpoints
  - Real-time updates without page refresh
  - JavaScript Interop for map integration

### 2. **Service Layer** (ScentPolygonLibrary)
- **Technology**: .NET 9 Class Library
- **Pattern**: Hosted Service (IHostedService, IDisposable)
- **Key Classes**:
  - `ScentPolygonService`: Main background service
  - `ScentPolygonCalculator`: Static utility methods
  - `ScentPolygonConfiguration`: Configuration settings
- **Features**:
  - Polls database every 1 second
  - Thread-safe in-memory polygon storage
  - Event-driven architecture
  - On-demand unified polygon generation

### 3. **Data Access Layer** (ReadRoverDBStubLibrary)
- **Technology**: .NET 9 Class Library
- **Pattern**: Repository pattern with interface abstraction
- **Implementations**:
  - PostgreSQL (Npgsql)
  - GeoPackage (SQLite with spatial extensions)
- **Factory**: Automatic connection testing and provider selection

### 4. **Data Storage Layer**
- **PostgreSQL**: Enterprise-grade spatial database
  - PostGIS for spatial types
  - Hosted on 192.168.1.254:5432
- **GeoPackage**: OGC standard file-based storage
  - SQLite with spatial extensions
  - Portable, QGIS-compatible

### 5. **Data Generation Layer** (RoverSimulator)
- **Technology**: .NET 9 Console Application
- **Purpose**: Generate realistic rover measurement data
- **Output**: GPS coordinates + wind measurements

### 6. **Testing Layer** (ScentPolygonTester)
- **Technology**: .NET 9 Console Application
- **Purpose**: Monitor and validate polygon generation
- **Output**: GeoPackage file for QGIS visualization

---

## Data Flow Sequence

```
1. RoverSimulator
   ? (Generates measurements)
2. PostgreSQL / GeoPackage
   ? (Stores rover_measurements)
3. ScentPolygonService (Background service)
   ? (Polls every 1s, generates polygons)
4. In-Memory Storage (ConcurrentDictionary)
   ? (Thread-safe polygon collection)
5. Events (PolygonsUpdated)
   ? (Notifies subscribers)
6. Blazor API Endpoints
   ? (Converts to GeoJSON)
7. Leaflet.js Map
   ? (Visualizes on map)
8. User Browser
```

---

## Scent Polygon Algorithm

### Individual Polygon Generation
1. **Downwind Fan** (Wind-based detection zone)
   - Direction: Wind direction + 180° (downwind)
   - Distance: 60m - 280m (based on wind speed)
   - Angle: ±5° to ±30° (narrower at higher speeds)

2. **Omnidirectional Circle** (Close-range detection)
   - Radius: 30 meters (configurable)
   - Independent of wind

3. **Union Operation** (NetTopologySuite)
   - Combines fan + circle
   - Creates single polygon geometry

### Unified Polygon Generation (NEW)
1. **Progressive Union** - Combines multiple individual polygons
2. **Batch Processing** - Optimized for large datasets
3. **Statistics Calculation** - Coverage efficiency, overlap analysis
4. **Geometry Simplification** - Douglas-Peucker smoothing
5. **Fallback Handling** - Convex hull for problematic unions

---

## Technology Stack

| Layer | Technology | Purpose |
|-------|-----------|---------|
| **Frontend** | Blazor Server (.NET 9) | Web UI with C# |
| **Mapping** | Leaflet.js | Interactive maps |
| **Geometry** | NetTopologySuite | Spatial operations |
| **Database** | PostgreSQL + PostGIS | Spatial data storage |
| **Alternative DB** | GeoPackage (SQLite) | Portable file storage |
| **Background Service** | IHostedService | Continuous monitoring |
| **Data Format** | GeoJSON, WKT | Interoperability |

---

## Design Patterns

1. **Hosted Service Pattern**
   - Background processing
   - Lifecycle management (StartAsync/StopAsync)
   - Graceful shutdown

2. **Repository Pattern**
   - Abstract data access (IRoverDataReader)
   - Multiple implementations (PostgreSQL, GeoPackage)

3. **Event-Driven Architecture**
   - Loose coupling between components
   - Real-time notifications

4. **Factory Pattern**
   - Connection testing
   - Automatic provider selection

5. **Singleton Service**
   - Single instance in Blazor DI container
   - Shared state across application

---

## Key Features

? **Real-time Monitoring**: Polls database every second  
? **Event-Driven**: Loosely coupled components  
? **Thread-Safe**: Concurrent dictionary for polygon storage  
? **Flexible Data Sources**: PostgreSQL or GeoPackage  
? **Unified Coverage**: Combine multiple polygons into total coverage area  
? **Web Visualization**: Interactive Leaflet.js maps  
? **GeoJSON API**: Standard format for interoperability  
? **Testing Tools**: Console monitor with GeoPackage output  
? **No Persistence**: Service-only architecture (no polygon database)  

---

## Performance Characteristics

- **Polling Frequency**: 1 second (configurable)
- **Polygon Generation**: ~1-5ms per polygon
- **Union Operations**: ~10-100ms for 50-500 polygons
- **Memory**: All polygons stored in-memory (ConcurrentDictionary)
- **Thread Safety**: Lock-free concurrent operations
- **Scalability**: Suitable for real-time rover tracking scenarios

---

## Configuration Points

1. **Database Selection**: PostgreSQL vs GeoPackage
2. **Poll Interval**: How often to check for new data
3. **Scent Parameters**: Radius, fan points, distance multipliers
4. **Output Formats**: GeoJSON, WKT, GeoPackage
5. **Map Styling**: Colors based on wind speed
6. **Unified Polygon Options**: All, latest N, by session, by time range

---

## Future Enhancements

- SignalR for real-time push updates
- Authentication and authorization
- Historical data playback/animation
- Mobile-responsive design
- Data export capabilities
- Multi-rover support
- Advanced filtering and search
