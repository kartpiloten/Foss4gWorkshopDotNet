@page "/"

<h1 style="color: red; font-size: 48px;">HELLO WORLD</h1>
<p style="color: blue; font-size: 24px;">If you can see this, Blazor is working</p>

@code {
    private ScentMap? _map;
    private string? _error;
    private Timer? _timer;
    private int _lastSequence = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                Console.WriteLine("Index: OnAfterRenderAsync - starting initialization");
                await LoadInitialDataAsync();
                _timer = new Timer(async _ =>
                {
                    try
                    {
                        await InvokeAsync(async () => await LoadIncrementalDataAsync());
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Timer error: {ex.Message}");
                    }
                }, null, TimeSpan.FromSeconds(8), TimeSpan.FromSeconds(8));
            }
            catch (Exception ex)
            {
                _error = $"Init error: {ex.Message}";
                Console.WriteLine($"OnAfterRenderAsync error: {ex}");
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private async Task LoadInitialDataAsync()
    {
        try
        {
            Console.WriteLine("LoadInitialDataAsync: Starting...");
            var points = await Reader.GetAllAsync();
            Console.WriteLine($"LoadInitialDataAsync: Got {points.Count} points");
            
            if (points.Count == 0)
            {
                Console.WriteLine("LoadInitialDataAsync: No points, returning");
                return;
            }

            var coordinates = points.Select(p => new Coordinate(p.Longitude, p.Latitude)).ToArray();
            var trail = new LineString(coordinates);
            
            Console.WriteLine($"LoadInitialDataAsync: Created trail with {coordinates.Length} coordinates");
            
            if (_map != null)
            {
                Console.WriteLine("LoadInitialDataAsync: Updating trail");
                await _map.UpdateTrailAsync(trail);
            }
            else
            {
                Console.WriteLine("LoadInitialDataAsync: _map is null!");
            }

            var coverage = await Generator.GetUnifiedPolygonAsync();
            Console.WriteLine($"LoadInitialDataAsync: Got coverage: {coverage != null}");
            
            if (coverage?.Polygon != null && _map != null)
            {
                Console.WriteLine("LoadInitialDataAsync: Updating coverage");
                await _map.UpdateCoverageAsync(coverage.Polygon);
            }

            _lastSequence = points.Max(p => p.Sequence);

            var latest = points.Last();
            if (_map != null)
            {
                Console.WriteLine($"LoadInitialDataAsync: Updating position to ({latest.Longitude}, {latest.Latitude})");
                await _map.UpdatePositionAsync(
                    new Point(latest.Longitude, latest.Latitude),
                    latest.WindSpeedMps,
                    latest.WindDirectionDeg
                );
            }
            
            Console.WriteLine("LoadInitialDataAsync: Complete");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
            Console.WriteLine($"LoadInitialDataAsync error: {ex}");
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadIncrementalDataAsync()
    {
        try
        {
            var newPoints = await Reader.GetNewSinceSequenceAsync(_lastSequence);
            if (newPoints.Count == 0) return;

            var newCoords = newPoints.Select(p => new Coordinate(p.Longitude, p.Latitude)).ToArray();
            
            if (_map != null)
                await _map.AppendTrailCoordsAsync(newCoords);

            var coverage = await Generator.GetUnifiedPolygonAsync();
            if (coverage?.Polygon != null && _map != null)
                await _map.UpdateCoverageAsync(coverage.Polygon);

            _lastSequence = newPoints.Max(p => p.Sequence);

            var latest = newPoints.Last();
            if (_map != null)
                await _map.UpdatePositionAsync(
                    new Point(latest.Longitude, latest.Latitude),
                    latest.WindSpeedMps,
                    latest.WindDirectionDeg
                );
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
