@page "/"
@inject IJSRuntime JS

<!-- Correct static file reference (remove ~ which isn't resolved in .razor link tags) -->
<link href="css/fullscreen-map.css" rel="stylesheet" />

<!-- Fallback inline critical styles to ensure map always has size even if external CSS fails to load -->
<style>
    #map { position: fixed; inset: 0; width:100vw; height:100vh; z-index:1; background:#dcdcdc; }
</style>

<!-- Fullscreen map -->
<div id="map"></div>

<!-- Overlay UI -->
<div class="overlay-top-left">
    <h3>FrontendOpenLayers Rover Tracker</h3>
</div>

@if (!string.IsNullOrEmpty(_error))
{
    <div class="overlay-error">Error: @_error</div>
}
@if (!string.IsNullOrEmpty(_debugInfo))
{
    <div class="overlay-debug">@_debugInfo</div>
}

@code {
    private string? _error;
    private string? _debugInfo;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await InitializeMapWithRetryAsync();
    }

    private async Task InitializeMapWithRetryAsync()
    {
        const int maxRetries = 5;
        for (int attempt = 1; attempt <= maxRetries; attempt++)
        {
            try
            {
                _debugInfo = $"Initializing OpenLayers map... ({attempt}/{maxRetries})";
                StateHasChanged();
                await Task.Delay(300 * attempt);

                var olAvailable = await JS.InvokeAsync<bool>("eval", "typeof ol !== 'undefined'");
                if (!olAvailable)
                {
                    if (attempt == maxRetries) _error = "OpenLayers library failed to load";
                    continue;
                }

                var fnAvailable = await JS.InvokeAsync<bool>("eval", "typeof window.initOpenLayersMap === 'function'");
                if (!fnAvailable)
                {
                    if (attempt == maxRetries)
                    {
                        _error = "Map initialization function not found";
                        await TryLoadScriptManuallyAsync();
                    }
                    continue;
                }

                await JS.InvokeVoidAsync("initOpenLayersMap");
                _debugInfo = null; _error = null; StateHasChanged();
                return;
            }
            catch (Exception ex)
            {
                if (attempt == maxRetries) _error = ex.Message;
            }
        }
        StateHasChanged();
    }

    private async Task TryLoadScriptManuallyAsync()
    {
        var load = @"return new Promise((resolve,reject)=>{if (typeof window.initOpenLayersMap==='function'){resolve(true);return;}const s=document.createElement('script');s.src='js/openlayersInit.js';s.onload=()=>setTimeout(()=>typeof window.initOpenLayersMap==='function'?resolve(true):reject(),120);s.onerror=()=>reject();document.head.appendChild(s);});";
        if (await JS.InvokeAsync<bool>("eval", load))
        {
            await JS.InvokeVoidAsync("initOpenLayersMap");
            _error = null; _debugInfo = null;
        }
    }
}
