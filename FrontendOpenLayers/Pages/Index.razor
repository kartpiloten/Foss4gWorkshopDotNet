@page "/"
@using FrontendOpenLayers.Components
@using NetTopologySuite.Geometries
@using ScentPolygonLibrary
@using RoverData.Repository
@inject IServiceProvider ServiceProvider

<ScentMap @ref="_map" />

<div style="position: fixed; top: 10px; left: 10px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); pointer-events: auto; max-width: 300px; width: auto; height: auto;">
    <h3 style="margin: 0 0 15px 0; font-size: 1.5rem; color: #2d5a27;">FrontendOpenLayers Rover Tracker</h3>
    <ForestCoveragePie />
</div>

@if (!string.IsNullOrEmpty(_error))
{
    <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1001; background: rgba(220, 53, 69, 0.95); color: white; padding: 10px 20px; border-radius: 6px; pointer-events: auto;">
        Error: @_error
    </div>
}

@code {
    private ScentMap? _map;
    private string? _error;
    private Timer? _timer;
    private int _lastSequence = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(500);
            
            try
            {
                await LoadInitialDataAsync();
                _timer = new Timer(async _ =>
                {
                    try
                    {
                        await InvokeAsync(async () => await LoadIncrementalDataAsync());
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Timer error: {ex.Message}");
                    }
                }, null, TimeSpan.FromSeconds(8), TimeSpan.FromSeconds(8));
            }
            catch (Exception ex)
            {
                _error = $"Init error: {ex.Message}";
                Console.WriteLine($"OnAfterRenderAsync error: {ex}");
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private async Task LoadInitialDataAsync()
    {
        Console.WriteLine("Index: LoadInitialDataAsync starting...");
        try
        {
            using var scope = ServiceProvider.CreateScope();
            var reader = scope.ServiceProvider.GetRequiredService<IRoverDataRepository>();
            var generator = scope.ServiceProvider.GetRequiredService<ScentPolygonGenerator>();      
            var points = await Task.Run(() => reader.GetAllAsync());
            
            if (points.Count == 0)
            {
                await InvokeAsync(StateHasChanged);
                return;
            }

            var coordinates = points.Select(p => new Coordinate(p.Longitude, p.Latitude)).ToArray();
            var trail = new LineString(coordinates);
            
            if (_map != null)
                await _map.UpdateTrailAsync(trail);

            Console.WriteLine($"Index: Getting polygon for {points.Count} points...");
            var coverage = await generator.GetUnifiedPolygonAsync();
            Console.WriteLine($"Index: Coverage polygon null? {coverage?.Polygon == null}");
            if (coverage?.Polygon != null && _map != null)
            {
                Console.WriteLine($"Index: Calling UpdateCoverageAsync with {coverage.Polygon.Coordinates.Length} coords");
                await _map.UpdateCoverageAsync(coverage.Polygon);
                Console.WriteLine("Index: UpdateCoverageAsync completed");
            }

            _lastSequence = points.Max(p => p.Sequence);

            var latest = points.Last();
            if (_map != null)
                await _map.UpdatePositionAsync(
                    new Point(latest.Longitude, latest.Latitude),
                    latest.WindSpeedMps,
                    latest.WindDirectionDeg
                );
            
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
            Console.WriteLine($"LoadInitialDataAsync error: {ex}");
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadIncrementalDataAsync()
    {
        try
        {
            using var scope = ServiceProvider.CreateScope();
            var reader = scope.ServiceProvider.GetRequiredService<IRoverDataRepository>();
            var generator = scope.ServiceProvider.GetRequiredService<ScentPolygonGenerator>();
            
            var newPoints = await reader.GetNewSinceSequenceAsync(_lastSequence);
            if (newPoints.Count == 0) return;
            
            var newCoords = newPoints.Select(p => new Coordinate(p.Longitude, p.Latitude)).ToArray();
            
            if (_map != null)
                await _map.AppendTrailCoordsAsync(newCoords);

            var coverage = await generator.GetUnifiedPolygonAsync();
            if (coverage?.Polygon != null && _map != null)
            {
                await _map.UpdateCoverageAsync(coverage.Polygon);
            }

            _lastSequence = newPoints.Max(p => p.Sequence);

            var latest = newPoints.Last();
            if (_map != null)
                await _map.UpdatePositionAsync(
                    new Point(latest.Longitude, latest.Latitude),
                    latest.WindSpeedMps,
                    latest.WindDirectionDeg
                );
            
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
