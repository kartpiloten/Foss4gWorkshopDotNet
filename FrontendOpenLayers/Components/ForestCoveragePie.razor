@inject ScentPolygonLibrary.ScentPolygonGenerator Generator
@implements IDisposable
@using System.Globalization

<div class="forest-pie-container">
    <svg viewBox="0 0 200 200" class="pie-chart">
        <!-- Background circle -->
        <circle cx="100" cy="100" r="80" fill="#f0f0f0" stroke="#ccc" stroke-width="2"/>
        
        <!-- Searched area slice (green) -->
        @if (_percentage > 0)
        {
            <path d="@GetPiePath()" fill="#4CAF50" stroke="#fff" stroke-width="2"/>
        }
        
        <!-- Center circle for donut effect -->
        <circle cx="100" cy="100" r="50" fill="white"/>
        
        <!-- Percentage text -->
    <text x="100" y="95" text-anchor="middle" class="pie-percentage">@_percentage.ToString("F1", CultureInfo.InvariantCulture)%</text>
        <text x="100" y="115" text-anchor="middle" class="pie-label">Searched</text>
    </svg>
    
    <div class="pie-info">
        <div class="info-row">
            <span class="info-label">Forest Area:</span>
            <span class="info-value">@FormatArea(_forestAreaM2)</span>
        </div>
        <div class="info-row">
            <span class="info-label">Searched:</span>
            <span class="info-value">@FormatArea(_searchedAreaM2)</span>
        </div>
    </div>
</div>

@code {
    private double _percentage = 0;
    private int _searchedAreaM2 = 0;
    private int _forestAreaM2 = 0;
    private System.Threading.Timer? _pollTimer;

    protected override void OnInitialized()
    {
        // Poll every 2 seconds for updates
        _pollTimer = new System.Threading.Timer(async _ => await PollForUpdates(), null, 0, 2000);
    }

    private async Task PollForUpdates()
    {
        try
        {
            var (searchedArea, forestArea) = await Generator.GetForestIntersectionAreasAsync();
            _searchedAreaM2 = searchedArea;
            _forestAreaM2 = forestArea;
            _percentage = forestArea > 0 ? ((double)searchedArea / forestArea) * 100 : 0;
            
            // Clamp percentage to 100 max
            if (_percentage > 100) _percentage = 100;
            
            // Update UI on Blazor's thread
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            // Ignore errors during polling
        }
    }

    private string GetPiePath()
    {
        if (_percentage <= 0) return "";
        if (_percentage >= 100)
        {
            // Full circle
            return "M 100,20 A 80,80 0 1,1 99.99,20 Z";
        }

        // Calculate end point of arc
        var angle = (_percentage / 100.0) * 2 * Math.PI;
        var endX = 100 + 80 * Math.Sin(angle);
        var endY = 100 - 80 * Math.Cos(angle);
        
        // Large arc flag if more than 50%
        var largeArc = _percentage > 50 ? 1 : 0;
        
        return string.Format(CultureInfo.InvariantCulture,
            "M 100,100 L 100,20 A 80,80 0 {0},1 {1:F2},{2:F2} Z", largeArc, endX, endY);
    }

    private string FormatArea(int areaM2)
    {
        if (areaM2 < 10000)
            return $"{areaM2} mÂ²";
        
        var hectares = areaM2 / 10000.0;
    return $"{hectares.ToString("F2", CultureInfo.InvariantCulture)} ha";
    }

    public void Dispose()
    {
        _pollTimer?.Dispose();
    }
}
